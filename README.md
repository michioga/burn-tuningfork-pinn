# 音叉 設計PINN (Tuning Fork Design PINN)

このプロジェクトは、[Burn](https://burn.dev/)フレームワークを使用して構築された、物理法則情報付きニューラルネットワーク（PINN）の実装です。
指定された周波数（Hz）を入力すると、その周波数を実現するための音叉の最適な寸法（プロングの長さ、直径など）を予測します。

## ✨ 特徴

- **逆問題解決**: 通常のシミュレーション（寸法→周波数）とは逆に、目標の周波数から最適な寸法を予測します。
- **物理法則情報付き学習**: モデルの損失関数に物理法則（片持ち梁の振動方程式）を組み込むことで、少ないデータでも物理的に妥当な結果を生成します。
- **バックエンド選択可能**: コマンドライン引数で計算バックエンド（WGPU, CUDA, NdArray/CPU）を動的に切り替えられます。
- **インタラクティブな学習UI**: `burn-train`に組み込まれたCUIダッシュボードにより、学習の進捗（損失、学習率など）をリアルタイムで確認できます。

## 📂 プロジェクト構造

```
.
├── Cargo.toml
├── data/
│   └── fem_data_augmented.csv  # 学習用のデータセット
├── artifacts/                  # 学習済みモデルやログが保存されるディレクトリ
├── src/
│   ├── main.rs                 # アプリケーションのエントリポイント、CLI引数の解析
│   ├── constants.rs            # 物理定数やモデルの次元に関する定数
│   ├── dataset.rs              # CSVデータセットの読み込みとバッチ処理
│   ├── model.rs                # ニューラルネットワークモデルの定義
│   ├── physics.rs              # 物理法則に基づいた損失関数の定義
│   ├── train.rs                # モデルの学習処理
│   └── infer.rs                # 学習済みモデルを使った推論処理
└── README.md                   # このファイル
```

## セットアップ

1. **Rust toolchain**: [公式サイト](https://www.rust-lang.org/tools/install)の手順に従って、Rustをインストールします。
2. **CUDA (任意)**: CUDAバックエンドを使用する場合は、NVIDIAドライバと[CUDA Toolkit](https://developer.nvidia.com/cuda-toolkit)をインストールしてください。
3. **依存関係のインストール**:

    ```bash
    cargo build
    ```

## 🚀 使い方

### 学習

以下のコマンドでモデルの学習を開始します。`--backend`フラグで計算バックエンドを選択できます。

- **WGPU (デフォルト)**

  ```bash
  cargo run --release -- --backend wgpu train
  ```

- **CUDA**

  ```bash
  cargo run --release -- --backend cuda train
  ```

- **CPU (NdArray)**

  ```bash
  cargo run --release -- --backend nd-array train
  ```

### 推論

学習が完了すると`artifacts`ディレクトリにモデルが保存されます。以下のコマンドで、指定した周波数に対する音叉の寸法を予測します。

```bash
# 例: 440Hzの音叉の寸法を予測
cargo run --release -- infer --freq 440.0

# CUDAバックエンドで推論する場合
cargo run --release -- --backend cuda infer --freq 440.0

```

## 🧠 ハイブリッドモデル（PINN）の仕組み

このモデルは、単なるデータ学習と物理シミュレーションを組み合わせたハイブリッド（物理法則情報付きニューラルネットワーク、PINN）です。学習プロセスは以下の2つのモデルの連携によって機能します。

1. **学習モデル（ニューラルネットワーク）** 探索者 🧠
    - 入力された周波数に対し、最適と思われる寸法の組み合わせを**予測**します。これは、広大な設計空間の中から有望な候補を見つけ出す「探索者」の役割を担います。

2. **理論モデル（物理法則）** 評価者 📏
    - `src/physics.rs` 内の損失関数が「評価者」として機能します。
    - 学習モデルが予測した寸法を、**物理方程式**（片持ち梁の振動方程式）に代入し、「予測された周波数」を算出します。
    - この予測周波数と目標周波数との**誤差（物理損失）**を計算し、学習モデルにフィードバックします。

学習モデルは、この**物理損失**が最小になるように自身のパラメータを更新し続けます。これにより、単にデータセットを暗記するのではなく、「物理法則を満たす寸法を出力する方法」そのものを学習することが可能になります。

### 理論モデルで使われる物理方程式

理論モデル（`src/physics.rs`）は、以下の片持ち梁の振動に関する方程式を用いて、ニューラルネットワークが予測した寸法（プロングの長さ `L` と直径 `d`）から周波数 `f` を算出します。

1.  **断面積 (Area)**:
    $`
    A = \frac{\pi d^2}{4}
    `$

2.  **断面二次モーメント (Moment of Inertia)**:
    $`
    I = \frac{\pi d^4}{64}
    `$

3.  **周波数 (Frequency)**:
    $`
    f = \frac{k}{2\pi L^2} \sqrt{\frac{E \cdot I}{\rho \cdot A}}
    `$

ここで、
-   E: ヤング率 (`YOUNGS_MODULUS`)
-   `ρ`: 材料の密度 (`DENSITY`)
-   `k`: 振動モードの定数 (`K_FACTOR`)

これらの数式から計算された周波数と、目標周波数との誤差が「物理損失」となり、モデルはこの損失を最小化するように学習を進めます。

